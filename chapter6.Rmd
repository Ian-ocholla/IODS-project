# Longitudinal Data Anlaysis 

Wide data has a column for each variable whereas long format data has a column for possible variable type & a column for the values of those variables





graphical displays are useful for exposing patterns in the data
Display the data in table format
glimpse(RATSL)









Figure 8.6: plot boxplot without the outlier- is there evidence of a difference in location of the summary measure distributions in each group.

#require a formal test for a difference between the three groups
#apply a t-test to assess any difference between the groups and also calculate a condifence interval for this difference.

#use the data without the outlier (fig 8.5) to generate Table 8.3
Does the t-test confirms the lack of any evidence for a group difference
what is the range of CI, does it include zero.

#Incoporating pre-weight outcome values into the summary measure approach

#analysis of covariance
Weight taken prior to start of the program as baseline covariate




#dealing with missing values when using summary measure approach

#table 8.5. 




```{r}
# libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lme4)

```
## Chapter 8: Analysis of Longitudinal Data I: Graphical Displays Summary Measure Approach



## Load the data and check the variables and structure
```{r}
#set working directory
setwd("C:/LocalData/ocholla/IODS-project/Data")

RATS<- read.table("Rats.txt", header = TRUE, sep = '\t')

#convert variables ID and Group to factors
RATS<- within(RATS, {
  ID<- factor(ID)
  Group<- factor(Group)
})

#Convert data to long form
RATSL<- RATS%>% 
  gather(key = WD, value = Weight, -ID, -Group) %>% 
  #mutate a new variable Time by extracting the number of the day from WD
  mutate(Time = as.integer(substr(WD,3,4)))
glimpse(RATSL)
head(RATSL)
tail(RATSL)

```


# Figure 8.1 
#Draw the plot
#* plot the RATSL values for all 11 rats mean, differentiating between the  nutrition groups into which the rats have been randomized

```{r}
ggplot(RATSL, aes(x=Time, y= Weight, linetype = WD))+
  geom_line()+
  scale_linetype_manual(values = rep(1:10,
                                     times=4))+
  facet_grid(.~ Group, labeller = label_both)+
  theme(legend.position = "none")+
  scale_y_continuous(limits = c(min(RATSL$Weight),
                                max(RATSL$Weight)))

```

solution: weights score varied within the groups across the 9 weeks.
Rats in group 2 had the highest weight maintain throughout the period
In group 3: the weights tend to increase as period increased
In group 1: the weight ws relatively maintained across the period


#task 2: standardize values of each observation
i.e. value obtained by subtracting the relevant occassion mean from the original observation and then dividing by the corresponding standard deviation


```{r}
#standardise the variables weights
RATSL<- RATSL %>%
  group_by(Time) %>% 
  mutate(stdWeight = (Weight - mean(Weight))/ sd(Weight) ) %>% 
  ungroup()

#glimpse the data
glimpse(RATSL)


```


#Figure 8.2: plotting the mean profiles as side by side plots of the observation at diff time (Time aganist standardize weights)

```{r}
#plot again with the standardized weights

ggplot(RATSL, aes(x = Time, y = stdWeight,
                  linetype = WD))+
  geom_line()+
  scale_linetype_manual(values = rep(1:10,
                                     times = 4))+
  facet_grid(. ~Group, labeller = label_both)+ scale_y_continuous(name = "standardized Weights")

```

solution: the mean of group 2 and group 3 at 1 suggests a small difference between the two groups compared to group 1 whose mean is -1.


#Figure 8.3: 
mean response profiles for the two treatment groups in Rats data (plot of time against mean(weight)+/- se(weight))
```{r}
#number of subjects (days), baseline (week 0) included
n<- 16

#summary data with mean and standard error of bprs by treatment and week
RATSS<- RATSL %>%
  group_by(Group, Time) %>% 
  summarise(mean = mean(Weight), se = sd(Weight)/sqrt(n)) %>%
  ungroup()
#Glimpse the data
glimpse(RATSS)

```


```{r}
#plot the mean profiles
ggplot(RATSS, aes(x= Time, y= mean, linetype = Group, shape = Group))+
  geom_line()+
  scale_linetype_manual(values = c(1,2,3))+
  geom_point(size =3)+ #change from 3 to 2
  scale_shape_manual(values = c(1,2,3))+
  geom_errorbar(aes(ymin= mean -se, ymax= mean + se,
                    linetype ="1"), width= 0.3)+
  theme(legend.position = c(0.8,0.8))+
  scale_y_continuous(name = "mean(Weight)+/- se(Weight)")

```


#Figure 8.4: boxplot time aganist weight 
check if there are outliers in the weights across the time period

```{r}
ggplot(RATSL, aes(x= factor(Time), y = Weight, 
                  fill = Group))+
  geom_boxplot(position = position_dodge(width = 0.9))+
  theme_bw()+theme(panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank())+
  theme(legend.position = "bottom")+ #c(0.8,0.8)
  scale_x_discrete(name = "Time")

```

#Table 8.4. Anlaysis of covariance of the RATS datawith baseline RATS and Groups as covariates

Is the baseline strongly related to the rats weight taken after program started

#summary measure approach applied to the post weight of rats
 




```{r}
#Find the outlaw ...Outlier

#create a summary data by Group and WD with mean as the summary variable
RATSL8S<- RATSL %>%
  filter(Time > 1 ) %>% #change from 0 to 1 as 1 is the baseline date
  group_by(Group, WD) %>%
  summarise( mean = mean(Weight) )%>%
  ungroup()
#glimpse the data
glimpse(RATSL8S)

```

#task 6: calculate the measure and then look at boxplots of the measure for each group
(Figure 8.5)- boxplot of group against mean(weight), Time(8-64)

```{r}
#draw  a boxplot of the mean versus Group
ggplot(RATSL8S, aes(x = Group, y =mean)) +
  geom_boxplot()+
  stat_summary(fun.y = "mean", geom = "point", shape = 23, size =4, 
               fill = "blue")+
  scale_y_continuous(name = "mean(Weight), Time 8-64")

```

soln: indicates the mean summary measure- which one is skewed? which one has outlier
Decide weight score should be removed?
The mean summary measure is more variable in the second treatment group and its 
distribution in this group is somewaht skew
The boxplot of the second groups reveals an outlier, a subject whose BPRS score 
is the eight weeks is over 70. May cause bias conclusions for further compariosn of the groups

#No outliers so no figure 8.6

#Table 8.3

```{r}
# This is a so-called "R chunk" where you can write R code.

date()

```

```{r}
# This is a so-called "R chunk" where you can write R code.

date()

```

```{r}
# This is a so-called "R chunk" where you can write R code.

date()

```


## Chapter 9: Analysis of Longitudinal Data II: Linear Mixed Effects Models for Normal Response Variables

Longitudinal data, where a response variable is measured on each subject on different occasions poses a challenge as repeated measurement often are likely correlated rather than independent. 

To test how linear mixed effect models are applied data taken from Davis 2002 will be used. It comprises of 40 male subjects who were randomly assigned to **one or two treatment** groups and each subject was rated on the **Brief Psychiatric Rating Scale (BPRS)** measured before treatment began **(week 0)** and then at weekly interval for **eight weeks**. The BPRS assesses the level of 18 symptoms construct such as hostility, suspiciousness, hallucinations and grandiosity; each of these is rated from one (not presented) to seven (extremely severe). The scale is used to evaluate patients suspected of having schizophrenia.
The question of most interest is whether BPRS differs in the two treatments differ
 
### 9.3.1 Fitting the independence Model to the BPRS Data

Load the data, ignoring the repeated-measure structure of the data and assume that all the observation are independent of one another 
```{r}
#set working directory
setwd("C:/LocalData/ocholla/IODS-project/Data")
#Load the data sets (BPRS)
BPRS<- read.table("BPRS.txt", sep= " ", header = TRUE)
#convert subject and treatment from integer to factors
BPRS<- within(BPRS, {
  treatment<- factor(treatment)
  subject<- factor(subject)
})

#Add column on the number of count of men 
BPRS$ID<- seq.int(nrow(BPRS))
glimpse(BPRS)

```

The data is in wide form format, it needs to be converted to long form to be used for analysis


1. Convert the data to long form
```{r}

BPRSL<- gather(BPRS, key = weeks, value = bprs, week0:week8) %>%
  #extract the week number- adding the variable week into the dataset
  mutate(week = as.integer(substr(weeks, 5, 5)))
#take a glimpse at the BPRSL data
glimpse(BPRSL)
head(BPRSL);tail(BPRSL)
```
When we ignore the set of 9 bprs measurements come from the same subject, we have 360 bprs, weeks and treatment that can be easily analysed by using multiple linear regression


Plot the data, identifying the bprs observation in each treatment but ignoring the longitudinal nature of data
```{r}
ggplot(BPRSL, aes(x = week, y = bprs, group = ID))+
  geom_text(aes(label = treatment))+
  #geom_line(aes(linetype = subject))+
  scale_x_continuous(name = "Week (number)", breaks = seq(0,8,1))+
  scale_y_continuous(name = "bprs ()") + 
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = 
          element_blank())

```

In general, BPRS decreases in both treatment 1 &2  as the number of weeks increased. 
Men who have higher BPRS values at the beginning tend to have higher values throughout the study.


#### Fit a multiple linear regression model

Fit a multiple linear regression model with bprs as response and week and  treatment as explanatory variables.

```{r}

#create a regression model BPRS_reg
BPRS_reg<- lm(bprs ~ week + treatment, data = BPRSL)
#summary 
summary(BPRS_reg)


```

From the model, the week variable is highly significant (p<0.5) and negatively correlated to BPRS measure. Implying that with increase in weeks, the BPRS decreased.
Treatment 2 is not significant when holding Treatment 1 as a constant.
The two explanatory variables explained approximately 18% of BPRS variability.
This model (multiple linear regression) assumes independence of the repeated measures of BPRS, and thus assumption is highly unlikely.

### 9.3.2 Fitting Linear Mixed Models to the BPRS data

A graphical display of the bprs data takes into account the longitudinal structure of the data by joining together the bprs measures belonging to each man. 

```{r}
#Figure 9.2 plot of individual rat growth profiles
ggplot(BPRSL, aes(x= week, y = bprs, group= ID))+ #subject
  geom_line(aes(linetype= treatment))+
  scale_x_continuous(name= "Weeks (number)", breaks = seq(0,8,1))+
  scale_y_continuous(name = "bprs")+
  theme_bw()+ theme(legend.position = "top")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = 
          element_blank())

```

From the plot, there is a general decline in bprs across all men as the number of weeks increased.


A scatterplot matrix of repeated measures of BPRS to assess the independence of the repeated measures

```{r}
pairs(BPRS[, 3:11], cex = 0.7)

```

From the scatter plot: The repeated measures of bprs are not independent of one another.They are correlated with one another.



To begin more formal analysis of the BPRS rate, first fit the random intercept model and include the two explanatory variables.

```{r}
#create a random intercept model
BPRS_ref<- lmer(bprs ~ week + treatment + (1 | ID), data =  BPRSL, REML = FALSE)

#print the summary of the model
summary(BPRS_ref)

```

The estimated variance of the subject random effects (97.39) is not very large
if large- it indicates the considerable variation in the intercept of the regression fits of the individual subject treatment profile
-check if the estimated error of week is smaller in table 9.4 than it is in table 9.3

#Table 9.5 result from fitting the random intercept and slope model to the man treatment data
```{r}
BPRS_ref1<- lmer(bprs ~ week + treatment + (week|ID), data = BPRSL, REML = FALSE)
#print a summary of the model
summary(BPRS_ref1)

#perform an ANOVA test on the two models
anova(BPRS_ref1,BPRS_ref)

```
check the fixed effects, likeliood ratio test, chi-squared statistics and degree of freedom and the associated p-value (big or very small?)



## Table 9.6
```{r}
#create a random intercept and random slope model
BPRS_ref2<- lmer(bprs ~ week * treatment + (week|ID),
                 data = BPRSL, REML = FALSE)

#print a summary of the model
summary(BPRS_ref2)

#perform an ANOVA test on the two models
anova(BPRS_ref1, BPRS_ref2)

```
#Table 9.6: table of the model results
what is the likelihood ratio test of the interaction random intercept and slope model aganist the corresponding model without interaction is... with ..DF, what is the associated p-value (big or small). Conclude if the interaction model provides a better fit for the men treatment data.
what is the estimated regression parameters for interaction indicate...between the two groups..


## Figure 9.4 
#find the fitted values from the interaction model and plot the fitted growth rates for each rat
#Figure 9.4 observed vs fitted plots

```{r}
#create a vector of the fitted values
Fitted<- fitted(BPRS_ref2)
#Create a new column fitted to RATSL
BPRSL<- BPRSL%>% 
  mutate(Fitted)

#draw the plot of RATSL
ggplot(BPRSL, aes(x = week, y = bprs, group = ID))+  #group = subject
  geom_line(aes(linetype = treatment))+ 
  #geom_line()+
  #scale_linetype_manual(values = c("solid", "dashed"))+
  #geom_point(aes(col = treatment), size = 2)+
  scale_x_continuous(name = "Week (number)", breaks = seq(0, 8,1))+
  scale_y_continuous(name = "Observed bprs ()")+
  theme_bw()+ theme(legend.position = "right")+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  ggtitle("observed")
  #theme(legend.position = "top")


#draw the plot of BPRSL
ggplot(BPRSL, aes(x = week, y= Fitted, group = ID))+
  geom_line(aes(linetype = treatment))+
  scale_x_continuous(name = "Week (number)", breaks = seq(0,8,1))+
  scale_y_continuous(name = "bprs (grams)")+
  theme_bw()+theme(legend.position = "right")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  ggtitle("Fitted")
  

```



```{r}
# This is a so-called "R chunk" where you can write R code.

date()

```
